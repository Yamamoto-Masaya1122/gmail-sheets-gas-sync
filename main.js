function saveGmailToSheetBySenderWithDomainFilter() {
  const start = new Date();

  // ç’°å¢ƒå¤‰æ•°å–å¾—
  const props = PropertiesService.getScriptProperties();
  const sheetId = props.getProperty('SPREADSHEET_ID');
  const sheetManager = SpreadsheetApp.openById(sheetId);
  const lastFetchTime = props.getProperty('LAST_FETCH_TIME');
  const lastFetchIds = JSON.parse(props.getProperty('LAST_FETCH_IDS') || '[]');
  const groupBaseUrl = props.getProperty('GROUP_BASE_URL');

  /**
   * ğŸ”½ ã‚·ãƒ¼ãƒˆåˆ†é¡ãƒ«ãƒ¼ãƒ«ï¼ˆã“ã“ã ã‘ç·¨é›†ã™ã‚Œã°ç¨®åˆ¥è¿½åŠ OKï¼‰
   * - key: ã‚·ãƒ¼ãƒˆå
   * - value: ãƒ‰ãƒ¡ã‚¤ãƒ³ã®é…åˆ—
   */
  const categoryDomainMap = {
    "é›»æ°—ãƒ»ã‚¬ã‚¹": [
      "gmail.com",
    ],
    "ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆé–¢é€£": [
      "groups.google.com",
      "ambi-tious.com",
      "googlegroups.com",
      "hornet-v.com"
    ],
    "ãã®ä»–": [] // ãƒãƒƒãƒã—ãªã‹ã£ãŸæ™‚
  };

  // âœ… ã‚·ãƒ¼ãƒˆåˆ†é¡ãƒ«ãƒ¼ãƒ«ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å…¨ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æŠ½å‡ºï¼ˆã€Œãã®ä»–ã€ã¯é™¤å¤–ï¼‰
  const allDomains = Object.entries(categoryDomainMap)
    .filter(([sheetName]) => sheetName !== "ãã®ä»–")
    .flatMap(([_, domains]) => domains);
  
  // âœ… Gmailæ¤œç´¢ã‚¯ã‚¨ãƒªã‚’ç”Ÿæˆï¼ˆé€ä¿¡å…ƒã‚’é™å®šï¼‰
  let query = `in:inbox (${allDomains.map(d => `from:${d}`).join(" OR ")})`;
  
  if (lastFetchTime) {
    query += ` after:${formatDateForQuery(lastFetchTime)}`;
  }

  Logger.log("æ¤œç´¢ã‚¯ã‚¨ãƒª: " + query);

  /**
   * â–¼ æ–°ç€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ­£ç¢ºã«æ‰±ã†ãŸã‚ã€
   *   ã¾ãšã€Œæœ€æ–°50ã‚¹ãƒ¬ãƒƒãƒ‰ã€ã‚’å–å¾—ã™ã‚‹
   */
  const threads = GmailApp.search(query, 0, 50);

  /**
   * â–¼ ã‚¹ãƒ¬ãƒƒãƒ‰å†…ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã™ã¹ã¦å±•é–‹ â†’ æœ€æ–°é †ã«ã‚½ãƒ¼ãƒˆ
   *   ãã®å¾Œã€ã€Œæœ€æ–°50ä»¶ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ã®ã¿ã«çµã‚Šè¾¼ã‚€
   */
  let messages = [];
  threads.forEach(thread => {
    thread.getMessages().forEach(msg => {
      messages.push({ thread, msg });
    });
  });

  // æ–°ã—ã„é †ã«ä¸¦ã¹æ›¿ãˆ
  messages.sort((a, b) => b.msg.getDate() - a.msg.getDate());

  // æœ€æ–°50ä»¶ã«åˆ¶å¾¡
  messages = messages.slice(0, 50);

  Logger.log(`æŠ½å‡ºã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç·æ•°ï¼ˆ50ä»¶ã«åˆ¶å¾¡æ¸ˆï¼‰: ${messages.length}`);

  let newestTime = lastFetchTime ? new Date(lastFetchTime) : new Date(0);
  let newestIds = [];
  let savedCount = 0;

  /**
   * â–¼ ãƒãƒƒãƒæ›¸ãè¾¼ã¿ç”¨ãƒãƒƒãƒ•ã‚¡
   * sheetName: rowData[][]
   */
  const sheetWriteBuffer = {};

  /**
   * â–¼ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å˜ä½ã§å‡¦ç†
   */
  messages.forEach(({ thread, msg }) => {
    const msgDate = msg.getDate();
    const msgId = msg.getId();
    const from = msg.getFrom();
    const threadId = thread.getId();

    // ğŸ”¹ é‡è¤‡ãƒã‚§ãƒƒã‚¯
    if (lastFetchTime) {
      const prev = new Date(lastFetchTime);

      if (msgDate < prev) return;
      if (
        msgDate.getTime() === prev.getTime() &&
        lastFetchIds.includes(msgId)
      ) {
        return;
      }
    }

    // ğŸ”¹ ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¤å®š â†’ æ›¸ãè¾¼ã¿å…ˆã‚·ãƒ¼ãƒˆåã‚’å–å¾—
    const sheetName = categorizeSheet(from, categoryDomainMap);
    if (!sheetName) return;

    // æ›¸ãè¾¼ã¿ãƒãƒƒãƒ•ã‚¡ãŒå­˜åœ¨ã—ãªã‘ã‚Œã°åˆæœŸåŒ–
    if (!sheetWriteBuffer[sheetName]) {
      sheetWriteBuffer[sheetName] = [];
    }

    const subject = msg.getSubject();

    // âœ… Googleã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚¹ãƒ¬ãƒƒãƒ‰URL
    const groupThreadUrl = `${groupBaseUrl}${subject}`;

    const hyperlink =
      msg.getAttachments().length > 0
        ? `=HYPERLINK("${groupThreadUrl}", "ã‚ã‚Š")`
        : "ãªã—";

    // æœ¬æ–‡ï¼ˆé«˜é€ŸåŒ–ã®ãŸã‚ substring â†’ replace ã®é †ï¼‰
    const body = msg
      .getPlainBody()
      .substring(0, 50)
      .replace(/\r?\n/g, ' ');

    // â–¼ ãƒãƒƒãƒ•ã‚¡ã«è¡Œãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
    sheetWriteBuffer[sheetName].push([
      "", "", "",
      msgDate,
      from,
      subject,
      body,
      hyperlink,
      threadId,
      msgId
    ]);

    savedCount++;

    // ğŸ”¹ åŸºæº–æ—¥æ™‚ã®æ›´æ–°ç”¨
    if (msgDate > newestTime) {
      newestTime = msgDate;
      newestIds = [msgId];
    } else if (msgDate.getTime() === newestTime.getTime()) {
      newestIds.push(msgId);
    }
  });

  // â–¶â–¶ ã“ã“ã§ã¾ã¨ã‚ã¦ä¸€æ‹¬æ›¸ãè¾¼ã¿
  Object.entries(sheetWriteBuffer).forEach(([sheetName, rows]) => {
    if (rows.length === 0) return;

    let sheet = sheetManager.getSheetByName(sheetName);

    // ğŸ”¹ ã‚·ãƒ¼ãƒˆä½œæˆï¼ˆåˆå›ã®ã¿ï¼‰
    if (!sheet) {
      sheet = sheetManager.insertSheet(sheetName);
      addHeaderRow(sheet);

      protectAutoGeneratedColumns(sheet);
    }

    // âœ… å¸¸ã«ã€Œ2è¡Œç›®ã€ã«æŒ¿å…¥ï¼ˆæœ€æ–°ãŒä¸€ç•ªä¸Šï¼‰
    sheet.insertRowsBefore(2, rows.length);

    // ğŸ”¥ ãƒãƒƒãƒä¸€æ‹¬æ›¸ãè¾¼ã¿ï¼ˆã“ã“ãŒé«˜é€ŸåŒ–ã®è‚ï¼‰
    sheet
      .getRange(2, 1, rows.length, rows[0].length)
      .setValues(rows);
  });

  // âœ… Script Properties æ›´æ–°
  if (savedCount > 0) {
    props.setProperty('LAST_FETCH_TIME', newestTime.toISOString());
    props.setProperty('LAST_FETCH_IDS', JSON.stringify(newestIds));

    Logger.log(`ğŸ†• åŸºæº–æ—¥æ™‚æ›´æ–°: ${newestTime}`);
  }

  Logger.log(
    `å‡¦ç†å®Œäº†: ${((new Date()) - start) / 1000} ç§’ï¼ˆä¿å­˜ä»¶æ•°: ${savedCount} ä»¶ï¼‰`
  );
}

/**
 * ãƒ¡ãƒ¼ãƒ« From â†’ ã‚·ãƒ¼ãƒˆåã«ãƒãƒƒãƒ”ãƒ³ã‚°
 */
function categorizeSheet(from, categoryDomainMap) {
  const lower = from.toLowerCase();

  for (const [sheetName, domains] of Object.entries(categoryDomainMap)) {
    if (domains.some(domain => lower.includes(domain))) {
      return sheetName;
    }
  }

  // ã©ã‚Œã«ã‚‚å±ã•ãªã„ â†’ "ãã®ä»–" ã‚’è¿”ã™ä»•æ§˜
  return "ãã®ä»–";
}

/**
 * ã“ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã¯ã‚·ãƒ¼ãƒˆä½œæˆæ™‚ã«1å›ã ã‘æŒ¿å…¥ã•ã‚Œã‚‹
 */
function addHeaderRow(sheet) {
  sheet.appendRow([
    "å¯¾å¿œç¢ºèª",
    "å‚™è€ƒ",
    "å¯¾å¿œè€…",
    "é€ä¿¡æ—¥æ™‚",
    "é€ä¿¡è€…",
    "ä»¶å",
    "æœ¬æ–‡",
    "æ·»ä»˜ã®æœ‰ç„¡",
    "ã‚¹ãƒ¬ãƒƒãƒ‰ID",
    "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ID"
  ]);

  sheet.setFrozenRows(1);
}

/**
 * Dã€œJåˆ—ã‚’ã€Œã‚ªãƒ¼ãƒŠãƒ¼å«ã‚ã¦å®Œå…¨ãƒ­ãƒƒã‚¯ï¼ˆGASå°‚ç”¨ï¼‰ã€ã«ã™ã‚‹
 */
function protectAutoGeneratedColumns(sheet) {
  const range = sheet.getRange("D:J");
  const protection = range
    .protect()
    .setDescription('Auto Mail Data Protected');

  const me = Session.getEffectiveUser().getEmail();
  protection.removeEditors(protection.getEditors());
  protection.addEditor(me);
  protection.setWarningOnly(false);

  range.setBackground("#f3f3f3");
}

/**
 * Gmailæ¤œç´¢ã‚¯ã‚¨ãƒªã®ã€Œafter:ã€å½¢å¼ã«åˆã‚ã›ã¦æ—¥ä»˜ã‚’æ•´å½¢ã™ã‚‹ã€‚
 * ä¾‹: "2024-12-01T12:00:00.000Z" â†’ "2024/12/1"
 */
function formatDateForQuery(dateString) {
  const d = new Date(dateString);

  return `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
}
